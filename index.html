import os
import random
import pygame
import logging
from io import BytesIO
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–≥—Ä—ã
SCREEN_WIDTH = 288
SCREEN_HEIGHT = 512
GRAVITY = 0.25
BIRD_JUMP = -7
PIPE_GAP = 100
PIPE_FREQUENCY = 1500  # milliseconds
GROUND_HEIGHT = 100

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pygame
pygame.init()
screen = pygame.Surface((SCREEN_WIDTH, SCREEN_HEIGHT))
clock = pygame.time.Clock()

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ (–∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
def create_surface(width, height, color):
    surf = pygame.Surface((width, height))
    surf.fill(color)
    return surf

# –†–µ—Å—É—Ä—Å—ã –∏–≥—Ä—ã
bird_surfaces = [
    create_surface(30, 30, (255, 255, 0)),  # –ñ–µ–ª—Ç–∞—è –ø—Ç–∏—á–∫–∞
    create_surface(30, 30, (255, 200, 0)),
    create_surface(30, 30, (255, 150, 0))
]
pipe_surface = create_surface(50, 300, (0, 128, 0))  # –ó–µ–ª–µ–Ω–∞—è —Ç—Ä—É–±–∞
background_surface = create_surface(SCREEN_WIDTH, SCREEN_HEIGHT, (135, 206, 235))  # –ì–æ–ª—É–±–æ–π —Ñ–æ–Ω
ground_surface = create_surface(SCREEN_WIDTH, GROUND_HEIGHT, (222, 184, 135))  # –ë–µ–∂–µ–≤–∞—è –∑–µ–º–ª—è

# –°–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_games = {}

class FlappyBirdGame:
    def __init__(self):
        self.reset()
    
    def reset(self):
        self.bird_rect = pygame.Rect(50, SCREEN_HEIGHT // 2, 30, 30)
        self.bird_movement = 0
        self.score = 0
        self.pipes = []
        self.last_pipe = pygame.time.get_ticks() - PIPE_FREQUENCY
        self.passed_pipe = False
        self.game_active = True
        self.bird_index = 0
        self.bird_flap = 0
    
    def update(self):
        if not self.game_active:
            return
        
        # –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ç–∏—Ü—ã
        self.bird_flap += 1
        if self.bird_flap > 5:
            self.bird_index = (self.bird_index + 1) % len(bird_surfaces)
            self.bird_flap = 0
        
        # –î–≤–∏–∂–µ–Ω–∏–µ –ø—Ç–∏—Ü—ã
        self.bird_movement += GRAVITY
        self.bird_rect.y += self.bird_movement
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä—É–±
        current_time = pygame.time.get_ticks()
        if current_time - self.last_pipe > PIPE_FREQUENCY:
            pipe_height = random.randint(100, 300)
            bottom_pipe = pipe_surface.get_rect(midtop=(SCREEN_WIDTH + 50, pipe_height))
            top_pipe = pipe_surface.get_rect(midbottom=(SCREEN_WIDTH + 50, pipe_height - PIPE_GAP))
            self.pipes.extend([bottom_pipe, top_pipe])
            self.last_pipe = current_time
        
        # –î–≤–∏–∂–µ–Ω–∏–µ —Ç—Ä—É–± –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
        self.passed_pipe = False
        for pipe in self.pipes[:]:
            pipe.x -= 2
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç—Ä—É–±—ã
            if pipe.right < 50 and not self.passed_pipe and pipe in self.pipes[::2]:
                self.score += 1
                self.passed_pipe = True
            
            # –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä—É–± –∑–∞ —ç–∫—Ä–∞–Ω–æ–º
            if pipe.right < 0:
                self.pipes.remove(pipe)
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
            if pipe.colliderect(self.bird_rect):
                self.game_active = False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∑–µ–º–ª–µ–π –∏–ª–∏ –ø–æ—Ç–æ–ª–∫–æ–º
        if self.bird_rect.top <= 0 or self.bird_rect.bottom >= SCREEN_HEIGHT - GROUND_HEIGHT:
            self.game_active = False
    
    def jump(self):
        if self.game_active:
            self.bird_movement = BIRD_JUMP
    
    def draw(self):
        # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–æ–Ω–∞
        screen.blit(background_surface, (0, 0))
        
        # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç—Ä—É–±
        for pipe in self.pipes:
            screen.blit(pipe_surface, pipe)
        
        # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–µ–º–ª–∏
        screen.blit(ground_surface, (0, SCREEN_HEIGHT - GROUND_HEIGHT))
        
        # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ç–∏—Ü—ã
        rotated_bird = pygame.transform.rotate(bird_surfaces[self.bird_index], -self.bird_movement * 3)
        screen.blit(rotated_bird, self.bird_rect)
        
        # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—á–µ—Ç–∞
        font = pygame.font.SysFont(None, 36)
        score_text = font.render(f'Score: {self.score}', True, (255, 255, 255))
        screen.blit(score_text, (10, 10))
        
        # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∫–æ–Ω—Ü–µ –∏–≥—Ä—ã
        if not self.game_active:
            font = pygame.font.SysFont(None, 48)
            game_over_text = font.render('Game Over', True, (255, 0, 0))
            restart_text = font.render('Tap to restart', True, (255, 255, 255))
            screen.blit(game_over_text, (SCREEN_WIDTH // 2 - game_over_text.get_width() // 2, 
                                         SCREEN_HEIGHT // 2 - 50))
            screen.blit(restart_text, (SCREEN_WIDTH // 2 - restart_text.get_width() // 2, 
                                      SCREEN_HEIGHT // 2 + 10))

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = update.effective_user.id
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id not in user_games:
        user_games[user_id] = FlappyBirdGame()
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    keyboard = [
        [InlineKeyboardButton("üîÑ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É", callback_data="start_game")],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data="help")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Flappy Bird!\n\n"
        "–ù–∞–∂–º–∏—Ç–µ 'üîÑ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É', —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É 'üîÑ –ü—Ä—ã–∂–æ–∫', —á—Ç–æ–±—ã –ø—Ç–∏—Ü–∞ –ª–µ—Ç–µ–ª–∞.",
        reply_markup=reply_markup
    )

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
    if user_id not in user_games:
        user_games[user_id] = FlappyBirdGame()
    
    game = user_games[user_id]
    
    if query.data == "start_game":
        game.reset()
        # –°–æ–∑–¥–∞–µ–º –∏–≥—Ä–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        keyboard = [
            [InlineKeyboardButton("üîÑ –ü—Ä—ã–∂–æ–∫", callback_data="jump")],
            [InlineKeyboardButton("üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫", callback_data="restart")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        game.update()
        
        # –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–≥—Ä—ã
        game.draw()
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å Pygame –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è Telegram
        img_buffer = BytesIO()
        pygame.image.save(screen, img_buffer, format='PNG')
        img_buffer.seek(0)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        await query.message.reply_photo(
            photo=img_buffer,
            caption=f"–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –¢–µ–∫—É—â–∏–π —Å—á–µ—Ç: {game.score}",
            reply_markup=reply_markup
        )
    
    elif query.data == "jump":
        game.jump()
        game.update()
        
        # –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–≥—Ä—ã
        game.draw()
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å Pygame –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è Telegram
        img_buffer = BytesIO()
        pygame.image.save(screen, img_buffer, format='PNG')
        img_buffer.seek(0)
        
        if game.game_active:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            await query.message.reply_photo(
                photo=img_buffer,
                caption=f"–¢–µ–∫—É—â–∏–π —Å—á–µ—Ç: {game.score}",
                reply_markup=query.message.reply_markup
            )
        else:
            # –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞
            keyboard = [
                [InlineKeyboardButton("üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫", callback_data="restart")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await query.message.reply_photo(
                photo=img_buffer,
                caption=f"–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: {game.score}",
                reply_markup=reply_markup
            )
    
    elif query.data == "restart":
        game.reset()
        game.update()
        
        # –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–≥—Ä—ã
        game.draw()
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å Pygame –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è Telegram
        img_buffer = BytesIO()
        pygame.image.save(screen, img_buffer, format='PNG')
        img_buffer.seek(0)
        
        keyboard = [
            [InlineKeyboardButton("üîÑ –ü—Ä—ã–∂–æ–∫", callback_data="jump")],
            [InlineKeyboardButton("üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫", callback_data="restart")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.message.reply_photo(
            photo=img_buffer,
            caption=f"–ù–æ–≤–∞—è –∏–≥—Ä–∞! –°—á–µ—Ç: {game.score}",
            reply_markup=reply_markup
        )
    
    elif query.data == "help":
        await query.message.reply_text(
            "–ö–∞–∫ –∏–≥—Ä–∞—Ç—å –≤ Flappy Bird:\n\n"
            "1. –ù–∞–∂–º–∏—Ç–µ 'üîÑ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É', —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.\n"
            "2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É 'üîÑ –ü—Ä—ã–∂–æ–∫', —á—Ç–æ–±—ã –ø—Ç–∏—Ü–∞ –ª–µ—Ç–µ–ª–∞.\n"
            "3. –ü—Ä–æ–ª–µ—Ç–∞–π—Ç–µ –º–µ–∂–¥—É —Ç—Ä—É–±–∞–º–∏, –Ω–µ –∫–∞—Å–∞—è—Å—å –∏—Ö.\n"
            "4. –ö–∞–∂–¥–∞—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω–Ω–∞—è —Ç—Ä—É–±–∞ –ø—Ä–∏–Ω–æ—Å–∏—Ç 1 –æ—á–∫–æ.\n"
            "5. –ï—Å–ª–∏ –≤—ã –∫–æ—Å–Ω–µ—Ç–µ—Å—å —Ç—Ä—É–±—ã –∏–ª–∏ –∑–µ–º–ª–∏, –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.\n\n"
            "–£–¥–∞—á–∏!"
        )

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    # –ó–∞–º–µ–Ω–∏—Ç–µ 'YOUR_BOT_TOKEN' –Ω–∞ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
    application = Application.builder().token("YOUR_BOT_TOKEN").build()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(button_handler))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    application.run_polling()

if __name__ == "__main__":
    main()